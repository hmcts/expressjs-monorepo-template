name: PR Claude Command

permissions:
  issues: write
  contents: write
  pull-requests: write

on:
  issue_comment:
    types: [created]

jobs:
  claude-command:
    name: Run Claude on PR
    runs-on: ubuntu-latest

    # Only run if this is a PR comment and contains "Claude:"
    if: |
      github.event.issue.pull_request != null &&
      contains(github.event.comment.body, 'Claude:')

    steps:
      - name: Extract prompt from comment
        id: extract_prompt
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"

          # Extract everything after "Claude:" (case-insensitive)
          PROMPT=$(echo "${COMMENT_BODY}" | sed -n 's/.*[Cc][Ll][Aa][Uu][Dd][Ee]:\s*\(.*\)/\1/p' | head -n1)

          if [ -z "${PROMPT}" ]; then
            echo "No prompt found after 'Claude:'"
            exit 1
          fi

          echo "Extracted prompt: ${PROMPT}"

          # Save prompt to file for multi-line handling
          echo "${PROMPT}" > /tmp/claude-prompt.txt

      - name: Get PR details
        id: pr_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.issue.number }}"
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

          PR_DATA=$(gh pr view "${PR_NUMBER}" --repo "${{ github.repository }}" --json headRefName,headRepository)
          HEAD_BRANCH=$(echo "${PR_DATA}" | jq -r '.headRefName')
          HEAD_REPO=$(echo "${PR_DATA}" | jq -r '.headRepository.nameWithOwner')

          echo "head_branch=${HEAD_BRANCH}" >> $GITHUB_OUTPUT
          echo "head_repo=${HEAD_REPO}" >> $GITHUB_OUTPUT

          echo "PR #${PR_NUMBER}: ${HEAD_REPO}:${HEAD_BRANCH}"

      - name: Checkout PR branch
        uses: actions/checkout@v5
        with:
          ref: ${{ steps.pr_details.outputs.head_branch }}
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22.21.0'

      - name: Install Claude Code CLI
        run: |
          npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code CLI
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
        run: |
          PROMPT=$(cat /tmp/claude-prompt.txt)

          echo "Running Claude with prompt: ${PROMPT}"

          claude -p "${PROMPT}" --dangerously-skip-permissions || true

      - name: Commit and push changes
        id: commit_changes
        run: |
          git add .

          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            PR_NUMBER="${{ steps.pr_details.outputs.pr_number }}"
            git commit -m "feat: claude command changes for PR #${PR_NUMBER}

Executed Claude command from PR comment.

PR: #${PR_NUMBER}"
            git push origin "${{ steps.pr_details.outputs.head_branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR with results
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr_details.outputs.pr_number }}"
          HAS_CHANGES="${{ steps.commit_changes.outputs.has_changes }}"
          PROMPT=$(cat /tmp/claude-prompt.txt)

          if [ "${HAS_CHANGES}" = "true" ]; then
            cat > /tmp/pr-comment.md <<EOF
🤖 **Claude Code has completed your request**

**Prompt:** \`${PROMPT}\`

I've analyzed your request and pushed changes to this PR branch.

**Commit:** $(git rev-parse --short HEAD)

Review the changes and let me know if you need any adjustments.
EOF
          else
            cat > /tmp/pr-comment.md <<EOF
🤖 **Claude Code analyzed your request but made no changes**

**Prompt:** \`${PROMPT}\`

I've reviewed your request but didn't make any code changes. This could mean:

- The request was informational and required no code changes
- The changes are already implemented
- The request needs more clarification
- The requested changes couldn't be completed automatically

Please review the workflow logs for more details or provide additional context.
EOF
          fi

          gh pr comment "${PR_NUMBER}" --body-file /tmp/pr-comment.md --repo "${{ github.repository }}"

      - name: Handle errors
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.pr_details.outputs.pr_number }}"
          PROMPT=$(cat /tmp/claude-prompt.txt || echo "Unable to extract prompt")

          cat > /tmp/error-comment.md <<EOF
❌ **Claude Code encountered an error**

**Prompt:** \`${PROMPT}\`

The workflow failed while processing your request. Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

Common issues:
- Invalid prompt format
- API key not configured (requires CLAUDE_API_KEY secret)
- Permission issues
- Claude Code CLI errors

Try again or contact the repository maintainer if the issue persists.
EOF

          gh pr comment "${PR_NUMBER}" --body-file /tmp/error-comment.md --repo "${{ github.repository }}" || true
