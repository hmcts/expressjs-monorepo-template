name: Smoke Test Job

on:
  workflow_call:
    inputs:
      preview-urls:
        required: true
        type: string
        description: "Base64-encoded JSON of preview URLs"

jobs:
  smoke-test:
    name: Smoke Test
    runs-on:
      group: azure-nonprod

    steps:
      - name: Decode preview URLs
        id: urls
        run: |
          URLS_B64="${{ inputs.preview-urls }}"
          URLS_JSON=$(echo -n "${URLS_B64}" | base64 -d)
          echo "Preview URLs JSON: ${URLS_JSON}"
          echo "urls=${URLS_JSON}" >> "$GITHUB_OUTPUT"

      - name: Health check - Web
        run: |
          URLS_JSON='${{ steps.urls.outputs.urls }}'
          WEB_URL=$(echo "${URLS_JSON}" | jq -r '.web // empty')

          if [ -n "${WEB_URL}" ]; then
            echo "Checking web health: ${WEB_URL}"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${WEB_URL}" || echo "000")
            echo "HTTP Status: ${HTTP_STATUS}"

            if [ "${HTTP_STATUS}" -ge 200 ] && [ "${HTTP_STATUS}" -lt 400 ]; then
              echo "✓ Web service is healthy"
            else
              echo "✗ Web service returned status ${HTTP_STATUS}"
              exit 1
            fi
          else
            echo "⚠ No web URL found, skipping web health check"
          fi

      - name: Health check - API
        run: |
          URLS_JSON='${{ steps.urls.outputs.urls }}'
          API_URL=$(echo "${URLS_JSON}" | jq -r '.api // empty')

          if [ -n "${API_URL}" ]; then
            echo "Checking API health: ${API_URL}"
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "${API_URL}" || echo "000")
            echo "HTTP Status: ${HTTP_STATUS}"

            if [ "${HTTP_STATUS}" -ge 200 ] && [ "${HTTP_STATUS}" -lt 400 ]; then
              echo "✓ API service is healthy"
            else
              echo "✗ API service returned status ${HTTP_STATUS}"
              exit 1
            fi
          else
            echo "⚠ No API URL found, skipping API health check"
          fi

      - name: Smoke test summary
        run: |
          echo "=========================================="
          echo "Smoke Test Summary"
          echo "=========================================="
          echo "All health checks passed successfully!"
