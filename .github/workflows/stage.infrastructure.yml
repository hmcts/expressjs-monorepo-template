name: Infrastructure Stage

on:
  workflow_call:
    inputs:
      plan-only:
        required: false
        type: boolean
        default: false
        description: "Run plan only, skip apply"
    outputs:
      plan-exitcode:
        description: "Terraform plan exit code (0=no changes, 2=changes)"
        value: ${{ jobs.terraform.outputs.plan-exitcode }}

jobs:
  terraform-fmt:
    name: Terraform Format
    uses: ./.github/workflows/job.terraform-fmt.yml

  terraform:
    name: Terraform
    needs: [terraform-fmt]
    uses: ./.github/workflows/job.terraform.yml
    with:
      environment: aat
      subscription: DCD-CNP-DEV
      aks-subscription: DCD-CFTAPPS-STG
      storage-account: nonprod
      plan-only: ${{ inputs.plan-only }}
    secrets: inherit
