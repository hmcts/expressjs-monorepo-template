# Detect Changes Job
#
# Reusable workflow to detect if files matching a pattern have changed.
# Use this to conditionally skip expensive jobs when irrelevant files change.
#
# Usage:
#   detect-changes:
#     uses: ./.github/workflows/job.detect-changes.yml
#     with:
#       paths: "^(yarn\\.lock|apps/|libs/)"
#
#   build:
#     needs: [detect-changes]
#     if: needs.detect-changes.outputs.has-changes == 'true'
#     ...
#
# Common patterns:
#   - Code changes:           "^(yarn\\.lock|apps/|libs/)"
#   - Infrastructure changes: "^infrastructure/"
#   - Helm changes:           "^helm/"
#   - E2E test changes:       "^e2e-tests/"

name: Detect Changes

on:
  workflow_call:
    inputs:
      paths:
        required: true
        type: string
        description: "Regex pattern for paths to check (e.g., '^(yarn\\.lock|apps/|libs/)')"
    outputs:
      has-changes:
        description: "Whether changes were detected in the specified paths"
        value: ${{ jobs.detect-changes.outputs.has-changes }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="origin/${{ github.base_ref }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          PATTERN='${{ inputs.paths }}'

          if git diff --name-only "$BASE_SHA" HEAD | grep -qE "$PATTERN"; then
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected matching pattern: $PATTERN"
          else
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected matching pattern: $PATTERN"
          fi
