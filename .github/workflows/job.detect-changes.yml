# Detect Changes Job
#
# Reusable workflow to detect if files matching a pattern have changed.
# Use this to conditionally skip expensive jobs when irrelevant files change.
#
# Usage:
#   detect-changes:
#     uses: ./.github/workflows/job.detect-changes.yml
#     with:
#       paths: "^(yarn\\.lock|apps/|libs/)"
#
#   build:
#     needs: [detect-changes]
#     if: needs.detect-changes.outputs.has-changes == 'true'
#     ...
#
# Common patterns:
#   - Code changes:           "^(yarn\\.lock|apps/|libs/)"
#   - Infrastructure changes: "^infrastructure/"
#   - Helm changes:           "^helm/"
#   - E2E test changes:       "^e2e-tests/"

name: Detect Changes

on:
  workflow_call:
    inputs:
      paths:
        required: true
        type: string
        description: "Regex pattern for paths to check (e.g., '^(yarn\\.lock|apps/|libs/)')"
    outputs:
      has-changes:
        description: "Whether changes were detected in the specified paths"
        value: ${{ jobs.detect-changes.outputs.has-changes }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      has-changes: ${{ steps.changes.outputs.has-changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        env:
          PATTERN: ${{ inputs.paths }}
        run: |
          # Determine base SHA for comparison
          # For PRs (including when called via workflow_call from a PR)
          if [ -n "${{ github.event.pull_request.base.ref }}" ]; then
            BASE_SHA="origin/${{ github.event.pull_request.base.ref }}"
          elif [ -n "${{ github.base_ref }}" ]; then
            BASE_SHA="origin/${{ github.base_ref }}"
          elif [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            BASE_SHA="${{ github.event.before }}"
          else
            # Fallback to comparing with origin/master
            BASE_SHA="origin/master"
          fi

          echo "Comparing $BASE_SHA...HEAD for pattern: $PATTERN"
          git diff --name-only "$BASE_SHA" HEAD || true

          if git diff --name-only "$BASE_SHA" HEAD | grep -qE "$PATTERN"; then
            echo "has-changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected matching pattern: $PATTERN"
          else
            echo "has-changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected matching pattern: $PATTERN"
          fi
