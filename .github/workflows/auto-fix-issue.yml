name: Auto-fix Issue

permissions:
  issues: write
  contents: write
  pull-requests: write
  id-token: write

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  auto-fix:
    name: Create Branch and Auto-fix with Claude
    runs-on: ubuntu-latest

    # Only run if:
    # 1. Issue was just opened, OR
    # 2. Issue was labeled with 'retry', OR
    # 3. Comment contains 'retry' (case-insensitive)
    if: |
      github.event_name == 'issues' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue != null &&
       contains(github.event.comment.body, 'retry'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get issue details
        id: issue_details
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          echo "issue_number=${ISSUE_NUMBER}" >> $GITHUB_OUTPUT

          ISSUE_DATA=$(gh issue view "${ISSUE_NUMBER}" --json title,body)
          ISSUE_TITLE=$(echo "${ISSUE_DATA}" | jq -r '.title')
          ISSUE_BODY=$(echo "${ISSUE_DATA}" | jq -r '.body // ""')

          echo "issue_title=${ISSUE_TITLE}" >> $GITHUB_OUTPUT

          # Save issue body to file for multi-line handling
          echo "${ISSUE_BODY}" > /tmp/issue_body.txt

      - name: Check if branch exists
        id: check_branch
        run: |
          ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue_details.outputs.issue_title }}"

          BRANCH_NAME="issue-${ISSUE_NUMBER}-$(echo "${ISSUE_TITLE}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//' | cut -c1-50)"

          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT

          if git ls-remote --heads origin "${BRANCH_NAME}" | grep -q "${BRANCH_NAME}"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            git fetch origin "${BRANCH_NAME}"
            git checkout "${BRANCH_NAME}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            git checkout -b "${BRANCH_NAME}"
          fi

      - name: Push branch if new
        if: steps.check_branch.outputs.exists == 'false'
        run: |
          git push -u origin "${{ steps.check_branch.outputs.branch_name }}"

      - name: Build prompt for Claude
        id: build_prompt
        run: |
          ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue_details.outputs.issue_title }}"
          ISSUE_BODY=$(cat /tmp/issue_body.txt)

          # Create the prompt with proper escaping
          PROMPT="Fix GitHub Issue #${ISSUE_NUMBER}: ${ISSUE_TITLE}

          Issue Description:
          ${ISSUE_BODY}

          Instructions:
          1. Read and understand the issue requirements carefully
          2. Analyze the codebase to identify what needs to be changed
          3. Implement the necessary changes following all standards in CLAUDE.md
          4. Run 'yarn lint', 'yarn format', 'yarn test', and 'yarn test:e2e' and fix any errors
          5. When done, summarize what you changed and why"

          # Save to output using delimiter to handle multiline
          echo "prompt<<PROMPT_DELIMITER" >> $GITHUB_OUTPUT
          echo "${PROMPT}" >> $GITHUB_OUTPUT
          echo "PROMPT_DELIMITER" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          prompt: ${{ steps.build_prompt.outputs.prompt }}
          claude_args: "--max-turns 10"

      - name: Commit and push changes
        id: commit_changes
        run: |
          git add .

          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"
            git commit -m "fix: auto-fix for issue #${ISSUE_NUMBER}

          Automatically generated by Claude Code based on issue requirements.

          Issue: #${ISSUE_NUMBER}"
            git push origin "${{ steps.check_branch.outputs.branch_name }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if PR exists
        id: check_pr
        if: steps.commit_changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          BRANCH_NAME="${{ steps.check_branch.outputs.branch_name }}"

          if gh pr list --head "${BRANCH_NAME}" --json number --jq '.[0].number' | grep -q '^[0-9]'; then
            PR_NUMBER=$(gh pr list --head "${BRANCH_NAME}" --json number --jq '.[0].number')
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.commit_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"
          ISSUE_TITLE="${{ steps.issue_details.outputs.issue_title }}"
          BRANCH_NAME="${{ steps.check_branch.outputs.branch_name }}"

          cat > /tmp/pr-body.md <<EOF
          ## Auto-fix for Issue #${ISSUE_NUMBER}

          This PR was automatically generated by Claude Code to address the reported issue.

          ### Issue
          **${ISSUE_TITLE}**

          ### Changes
          Claude Code has analyzed the issue and implemented changes following the project's coding standards (see CLAUDE.md).

          ### Review Checklist
          - [ ] Changes address the issue requirements
          - [ ] yarn lint
          - [ ] yarn format
          - [ ] yarn test
          - [ ] yarn test:e2e

          Fixes #${ISSUE_NUMBER}
          EOF

          gh pr create \
            --title "fix: ${ISSUE_TITLE}" \
            --body-file /tmp/pr-body.md \
            --base master \
            --head "${BRANCH_NAME}"

      - name: Update existing PR
        if: steps.commit_changes.outputs.has_changes == 'true' && steps.check_pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"

          cat > /tmp/pr-comment.md <<EOF
          ðŸ”„ **Claude Code has pushed new changes**

          The issue has been re-analyzed and additional changes have been made.

          Commit: ${{ github.sha }}
          EOF

          gh pr comment "${PR_NUMBER}" --body-file /tmp/pr-comment.md

      - name: Comment on issue
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"
          BRANCH_NAME="${{ steps.check_branch.outputs.branch_name }}"
          HAS_CHANGES="${{ steps.commit_changes.outputs.has_changes }}"

          if [ "${HAS_CHANGES}" = "true" ]; then
            if [ "${{ steps.check_pr.outputs.exists }}" = "true" ]; then
              PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
              cat > /tmp/comment.md <<EOF
          ðŸ¤– **Claude Code has updated the fix**

          I've pushed new changes to the existing pull request #${PR_NUMBER}.

          **Branch:** \`${BRANCH_NAME}\`

          Review the updated changes and let me know if you need any adjustments. Comment "retry" to run the fix again.
          EOF
            else
              cat > /tmp/comment.md <<EOF
          ðŸ¤– **Claude Code has attempted to fix this issue**

          I've analyzed the issue and created a pull request with proposed changes.

          **Branch:** \`${BRANCH_NAME}\`

          Please review the PR carefully. If the fix isn't quite right, comment "retry" on this issue to run the automation again.
          EOF
            fi
          else
            cat > /tmp/comment.md <<EOF
          ðŸ¤– **Claude Code analyzed the issue but made no changes**

          I've reviewed the issue but didn't make any code changes. This could mean:

          - The issue needs more clarification or details
          - The fix requires manual intervention or architectural decisions
          - The issue might already be resolved
          - The requested changes are ambiguous

          **Branch created:** \`${BRANCH_NAME}\`

          Please provide more details or comment "retry" after updating the issue description.
          EOF
          fi

          gh issue comment "${ISSUE_NUMBER}" --body-file /tmp/comment.md

      - name: Remove retry label if present
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.issue_details.outputs.issue_number }}"

          # Remove retry label to prevent loops
          gh issue edit "${ISSUE_NUMBER}" --remove-label "retry" 2>/dev/null || true
