name: Master Deployment

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'aat'
        type: choice
        options:
          - aat
          - prod

concurrency:
  group: ${{ github.event_name == 'pull_request' && format('master-deploy-pr-{0}', github.event.pull_request.number) || 'master-deploy' }}
  cancel-in-progress: false

env:
  REGISTRY: hmctspublic.azurecr.io
  REGISTRY_PREFIX: expressjs-monorepo-template
  TERRAFORM_VERSION: 1.9.0

jobs:
  terraform:
    name: Terraform Plan & Apply
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CFT_PREVIEW }}

      - name: Terraform Init
        working-directory: infrastructure
        run: terraform init

      - name: Terraform Plan
        working-directory: infrastructure
        run: |
          terraform plan \
            -var="env=${{ github.event.inputs.environment || 'aat' }}" \
            -out=tfplan

      - name: Terraform Apply
        working-directory: infrastructure
        run: terraform apply -auto-approve tfplan

  detect-affected:
    name: Detect Affected Apps
    runs-on: ubuntu-latest
    outputs:
      affected-apps: ${{ steps.detect.outputs.affected-apps }}
      has-changes: ${{ steps.detect.outputs.has-changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Detect affected apps
        id: detect
        run: .github/scripts/detect-affected-apps.sh

  build-and-publish:
    name: Build & Publish ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: [terraform, detect-affected]
    if: needs.detect-affected.outputs.has-changes == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-affected.outputs.affected-apps) }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tags
        id: tags
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          FULL_SHA=$(git rev-parse HEAD)

          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "full-sha=${FULL_SHA}" >> $GITHUB_OUTPUT

      - name: Azure Docker Login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.REGISTRY_PREFIX }}-${{ matrix.app }}"

          echo "Building image: ${IMAGE_NAME}"

          docker build \
            --tag "${IMAGE_NAME}:${{ steps.tags.outputs.full-sha }}" \
            --tag "${IMAGE_NAME}:${{ steps.tags.outputs.short-sha }}" \
            --tag "${IMAGE_NAME}:latest" \
            --file apps/${{ matrix.app }}/Dockerfile \
            .

          echo "Pushing all tags..."
          docker push "${IMAGE_NAME}:${{ steps.tags.outputs.full-sha }}"
          docker push "${IMAGE_NAME}:${{ steps.tags.outputs.short-sha }}"
          docker push "${IMAGE_NAME}:latest"

          echo "Successfully pushed all image tags"

  publish-helm-chart:
    name: Package & Publish Helm Chart
    runs-on: ubuntu-latest
    needs: [build-and-publish]
    if: always() && (needs.build-and-publish.result == 'success' || needs.build-and-publish.result == 'skipped')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.13.0'

      - name: Login to Helm registry
        run: |
          echo ${{ secrets.REGISTRY_PASSWORD }} | helm registry login ${{ env.REGISTRY }} \
            --username ${{ secrets.REGISTRY_USERNAME }} \
            --password-stdin

      - name: Package and publish Helm chart
        run: .github/scripts/publish-helm-chart.sh
