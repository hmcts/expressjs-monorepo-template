name: Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  detect-code-changes:
    name: Detect Code Changes
    uses: ./.github/workflows/job.detect-changes.yml
    with:
      paths: "^(yarn\\.lock|apps/|libs/|helm/)"
      cache-key: code-pr-${{ github.event.pull_request.number }}

  detect-infra-changes:
    name: Detect Infrastructure Changes
    uses: ./.github/workflows/job.detect-changes.yml
    with:
      paths: "^infrastructure/"
      cache-key: infra-pr-${{ github.event.pull_request.number }}

  build-stage:
    name: Build
    needs: [detect-code-changes]
    if: needs.detect-code-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/stage.build.yml
    with:
      change-id: ${{ github.event.pull_request.number }}
    secrets: inherit

  infrastructure-stage:
    name: Infrastructure
    needs: [detect-infra-changes]
    if: needs.detect-infra-changes.outputs.has-changes == 'true'
    uses: ./.github/workflows/stage.infrastructure.yml
    with:
      plan-only: true
    secrets: inherit

  deploy-stage:
    name: Deploy
    needs: [build-stage, infrastructure-stage]
    if: always() && needs.build-stage.result == 'success' && needs.infrastructure-stage.result != 'failure'
    uses: ./.github/workflows/stage.deploy.yml
    with:
      change-id: ${{ github.event.pull_request.number }}
      timestamp: ${{ needs.build-stage.outputs.timestamp }}
      short-sha: ${{ needs.build-stage.outputs.short-sha }}
      affected-apps: ${{ needs.build-stage.outputs.affected-apps }}
      helm-apps: ${{ needs.build-stage.outputs.helm-apps }}
    secrets: inherit

  smoke-test-stage:
    name: Smoke Test
    needs: [deploy-stage]
    if: needs.deploy-stage.result == 'success'
    uses: ./.github/workflows/stage.smoke-test.yml
    with:
      change-id: ${{ github.event.pull_request.number }}
      preview-urls: ${{ needs.deploy-stage.outputs.urls }}

  e2e-stage:
    name: E2E
    needs: [smoke-test-stage, deploy-stage]
    if: needs.deploy-stage.result == 'success'
    uses: ./.github/workflows/stage.e2e.yml
    with:
      preview-urls: ${{ needs.deploy-stage.outputs.urls }}
    secrets: inherit

  # Save successful SHAs for future change detection comparisons within this PR
  save-code-success:
    name: Save Code SHA
    needs: [build-stage]
    if: always() && needs.build-stage.result == 'success'
    uses: ./.github/workflows/job.save-successful-sha.yml
    with:
      cache-key: code-pr-${{ github.event.pull_request.number }}

  save-infra-success:
    name: Save Infra SHA
    needs: [infrastructure-stage]
    if: always() && needs.infrastructure-stage.result == 'success'
    uses: ./.github/workflows/job.save-successful-sha.yml
    with:
      cache-key: infra-pr-${{ github.event.pull_request.number }}
