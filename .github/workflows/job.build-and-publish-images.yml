name: Build and Publish Images Job

on:
  workflow_call:
    inputs:
      change-id:
        required: true
        type: string
        description: "PR number or change identifier"
    outputs:
      affected-apps:
        description: "JSON array of apps that were affected by changes"
        value: ${{ jobs.detect-affected.outputs.affected-apps }}
      helm-apps:
        description: "JSON array of all apps with Helm charts"
        value: ${{ jobs.detect-affected.outputs.helm-apps }}
      has-changes:
        description: "Whether any apps were affected by changes"
        value: ${{ jobs.detect-affected.outputs.has-changes }}
      timestamp:
        description: "Build timestamp"
        value: ${{ jobs.build-and-publish.outputs.timestamp }}
      short-sha:
        description: "Short git SHA"
        value: ${{ jobs.build-and-publish.outputs.short-sha }}

env:
  CHANGE_ID: ${{ inputs.change-id }}
  SHORT_SHA: ${{ github.sha }}
  REGISTRY: hmctspublic.azurecr.io

jobs:
  detect-affected:
    name: Detect Affected Apps
    runs-on: ubuntu-latest
    outputs:
      affected-apps: ${{ steps.detect.outputs.affected-apps }}
      helm-apps: ${{ steps.detect.outputs.helm-apps }}
      has-changes: ${{ steps.detect.outputs.has-changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Detect affected apps
        id: detect
        run: .github/workflows/jobs/build-and-publish-images/detect-affected-apps.sh

  build-and-publish:
    name: Build & Publish ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: detect-affected
    if: needs.detect-affected.outputs.has-changes == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-affected.outputs.affected-apps) }}
    permissions:
      contents: read
      id-token: write
    outputs:
      timestamp: ${{ steps.metadata.outputs.timestamp }}
      short-sha: ${{ steps.metadata.outputs.short-sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate build metadata
        id: metadata
        run: .github/workflows/jobs/build-and-publish-images/generate-build-metadata.sh "${{ env.CHANGE_ID }}" "${{ github.sha }}" "${{ matrix.app }}"

      - name: Login to Azure Container Registry
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.REGISTRY_LOGIN_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Build and push Docker image
        run: |
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.REGISTRY_PREFIX }}"
          FULL_TAG="${IMAGE_NAME}:${{ env.IMAGE_TAG }}"
          STATIC_TAG="${IMAGE_NAME}:pr-${{ env.CHANGE_ID }}"

          echo "Building image: ${FULL_TAG}"

          docker build \
            --tag "${FULL_TAG}" \
            --tag "${STATIC_TAG}" \
            --file apps/${{ matrix.app }}/Dockerfile \
            .

          echo "Pushing timestamped tag: ${FULL_TAG}"
          docker push "${FULL_TAG}"

          echo "Pushing static tag: ${STATIC_TAG}"
          docker push "${STATIC_TAG}"

          echo "Successfully pushed both tags"
