name: Build and Publish Images Job

on:
  workflow_call:
    inputs:
      change-id:
        required: true
        type: string
        description: "PR number or change identifier"
    outputs:
      affected-apps:
        description: "JSON array of apps that were affected by changes"
        value: ${{ jobs.detect-affected.outputs.affected-apps }}
      helm-apps:
        description: "JSON array of all apps with Helm charts"
        value: ${{ jobs.detect-affected.outputs.helm-apps }}
      has-changes:
        description: "Whether any apps were affected by changes"
        value: ${{ jobs.detect-affected.outputs.has-changes }}
      timestamp:
        description: "Build timestamp"
        value: ${{ jobs.generate-metadata.outputs.timestamp }}
      short-sha:
        description: "Short git SHA"
        value: ${{ jobs.generate-metadata.outputs.short-sha }}

env:
  CHANGE_ID: ${{ inputs.change-id }}
  REGISTRY_NAME: hmctspublic

jobs:
  get-last-successful-sha:
    name: Get Last Successful Build SHA
    runs-on: ubuntu-latest
    outputs:
      sha: ${{ steps.get-sha.outputs.sha }}
    steps:
      - name: Restore last successful SHA from cache
        id: cache
        uses: actions/cache/restore@v5
        with:
          path: .last-successful-sha
          key: last-successful-docker-build-sha
          restore-keys: last-successful-docker-build-sha

      - name: Read SHA
        id: get-sha
        run: |
          if [ -f .last-successful-sha ]; then
            SHA=$(cat .last-successful-sha)
            echo "Found last successful SHA: $SHA"
            echo "sha=$SHA" >> $GITHUB_OUTPUT
          else
            echo "No cached SHA found, will use origin/master"
            echo "sha=" >> $GITHUB_OUTPUT
          fi

  detect-affected:
    name: Detect Affected Apps
    runs-on: ubuntu-latest
    needs: get-last-successful-sha
    outputs:
      affected-apps: ${{ steps.detect.outputs.affected-apps }}
      helm-apps: ${{ steps.detect.outputs.helm-apps }}
      has-changes: ${{ steps.detect.outputs.has-changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Install dependencies
        run: yarn install --immutable

      - name: Detect affected apps
        id: detect
        run: .github/workflows/jobs/build-and-publish-images/detect-affected-apps.sh "${{ needs.get-last-successful-sha.outputs.sha }}"

  generate-metadata:
    name: Generate Metadata
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.metadata.outputs.timestamp }}
      short-sha: ${{ steps.metadata.outputs.short-sha }}
    steps:
      - name: Generate metadata
        id: metadata
        run: |
          echo "timestamp=$(date +%Y%m%d%H%M%S)" >> "$GITHUB_OUTPUT"
          echo "short-sha=$(echo '${{ github.sha }}' | cut -c1-7)" >> "$GITHUB_OUTPUT"

  build-and-publish:
    name: Build & Publish ${{ matrix.app }}
    runs-on: ubuntu-latest
    needs: detect-affected
    if: needs.detect-affected.outputs.has-changes == 'true'
    strategy:
      matrix:
        app: ${{ fromJson(needs.detect-affected.outputs.affected-apps) }}
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Generate build metadata
        id: metadata
        run: .github/workflows/jobs/build-and-publish-images/generate-build-metadata.sh "${{ env.CHANGE_ID }}" "${{ github.sha }}" "${{ matrix.app }}"

      - name: Determine image tags
        id: tags
        run: |
          # If change-id is numeric (PR number), use pr-{id} prefix
          # Otherwise use the change-id directly (e.g., staging)
          if [[ "${{ env.CHANGE_ID }}" =~ ^[0-9]+$ ]]; then
            echo "tag1=pr-${{ env.CHANGE_ID }}-${{ steps.metadata.outputs.short-sha }}" >> $GITHUB_OUTPUT
            echo "tag2=pr-${{ env.CHANGE_ID }}" >> $GITHUB_OUTPUT
          else
            echo "tag1=${{ env.CHANGE_ID }}-${{ steps.metadata.outputs.short-sha }}" >> $GITHUB_OUTPUT
            echo "tag2=${{ env.CHANGE_ID }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and push Docker image
        uses: hmcts/cnp-githubactions-library/container-build-push-openid@main
        with:
          registry-name: ${{ env.REGISTRY_NAME }}
          azure-client-id: ${{ secrets.AZURE_CLIENT_ID }}
          azure-tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          image-name: ${{ env.REGISTRY_PREFIX }}
          dockerfile: apps/${{ matrix.app }}/Dockerfile
          context: .
          image-tags: |
            ${{ steps.tags.outputs.tag1 }}
            ${{ steps.tags.outputs.tag2 }}
