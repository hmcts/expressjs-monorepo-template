name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]

jobs:
  claude:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read # Required for Claude to read CI results on PRs
    steps:
      - name: Get PR information
        id: get-pr
        if: github.event.issue.pull_request || github.event.pull_request
        uses: actions/github-script@v8
        with:
          script: |
            if (github.event.issue.pull_request) {
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number
              });
              return pr.data;
            } else {
              return github.event.pull_request;
            }

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1
          repository: ${{ (github.event.issue.pull_request || github.event.pull_request) && fromJSON(steps.get-pr.outputs.result).head.repo.full_name || github.repository }}
          ref: ${{ (github.event.issue.pull_request || github.event.pull_request) && fromJSON(steps.get-pr.outputs.result).head.ref || github.ref }}

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: '**/yarn.lock'

      - name: Cache Yarn dependencies
        uses: actions/cache@v5
        with:
          path: |
            .yarn/cache
            .yarn/install-state.gz
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Generate Prisma client
        run: yarn db:generate

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          prompt: |
            Repository: ${{ github.repository }}
            Issue/PR: #${{ github.event.issue.number || github.event.pull_request.number }}

            ${{ github.event.comment.body || github.event.review.body || github.event.issue.body }}
          claude_args: |
            --dangerously-skip-permissions
            --append-system-prompt "You are running in a GitHub Action. The environment has been set up and yarn install has been run. You can use bash and yarn commands. Read @CLAUDE.md. Run yarn format, yarn lint and yarn test before committing changes. IMPORTANT: After committing, you MUST push the changes using 'git push'."
            --allowedTools "Bash(corepack:*),Bash(yarn:*),Bash(git:*)"

  spec:
    # Generates technical specifications from templates
    # Usage: @spec [template-name] (default: new-feature)
    # Available templates: new-feature, bugs, enhancement, technical-task, spike, non-functional-requirement
    if: |
      github.event_name == 'issue_comment' &&
      !github.event.issue.pull_request &&
      contains(github.event.comment.body, '@spec')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Parse template type
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Extract template name after @spec (default: new-feature)
          if [[ "$COMMENT" =~ @spec[[:space:]]+([a-zA-Z0-9_-]+) ]]; then
            TEMPLATE="${BASH_REMATCH[1]}"
          else
            TEMPLATE="new-feature"
          fi

          # Validate template exists
          if [[ -f "templates/$TEMPLATE" ]]; then
            echo "template=$TEMPLATE" >> $GITHUB_OUTPUT
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "template=$TEMPLATE" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
          fi

      - name: Post error if template not found
        if: steps.parse.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const templates = fs.readdirSync('templates').join(', ');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùå Template \`${{ steps.parse.outputs.template }}\` not found.\n\nAvailable templates: ${templates}\n\nUsage: \`@spec [template-name]\``
            });

      - name: Run Claude Code for spec generation
        if: steps.parse.outputs.valid == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.CLAUDE_API_KEY }}
          prompt: |
            Generate a technical specification for this GitHub issue using the specified template.

            ## Template
            Read the template from: templates/${{ steps.parse.outputs.template }}

            ## Issue Details
            Issue #${{ github.event.issue.number }}
            Title: ${{ github.event.issue.title }}
            Body:
            ${{ github.event.issue.body }}

            ## Instructions
            1. Read the template file from templates/${{ steps.parse.outputs.template }}
            2. Read .claude/rules/design.md for GOV.UK Design System guidance
            3. Search the codebase for similar implementations to understand existing patterns
            4. Fill in ALL sections of the template with specific, actionable content based on the issue
            5. Replace all placeholder text [in brackets] with real content
            6. For wireframes, use ASCII art diagrams
            7. Output ONLY the completed specification markdown - no preamble or explanation

            IMPORTANT: Your entire output will be posted as a GitHub issue comment.
            Do not create files, make commits, or modify anything.
          claude_args: |
            --allowedTools "Read,Glob,Grep"
            --append-system-prompt "You are generating a technical specification. Output ONLY the completed specification markdown. Do not include any preamble like 'Here is the specification' - start directly with the specification content. Do not create files, make commits, or modify anything."
