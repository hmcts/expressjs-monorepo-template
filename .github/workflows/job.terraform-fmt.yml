name: Terraform Format Check

on:
  workflow_call:
    inputs:
      working-directory:
        required: false
        type: string
        default: "infrastructure"

jobs:
  terraform-fmt:
    name: Terraform Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for infrastructure changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="origin/${{ github.base_ref }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          if git diff --name-only "$BASE_SHA" HEAD | grep -q "^${{ inputs.working-directory }}/"; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes in ${{ inputs.working-directory }}/, skipping terraform fmt"
          fi

      - name: Setup Terraform
        if: steps.changes.outputs.has_changes == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version_file: ${{ inputs.working-directory }}/.terraform-version

      - name: Terraform Format Check
        if: steps.changes.outputs.has_changes == 'true'
        working-directory: ${{ inputs.working-directory }}
        run: |
          if ! terraform fmt -check -recursive -diff; then
            echo "::error::Terraform files are not formatted. Run 'terraform fmt -recursive' in the infrastructure directory to fix."
            exit 1
          fi
