name: Helm Cleanup Job

on:
  workflow_call:
    inputs:
      release-name:
        required: true
        type: string
        description: "Helm release name to delete"
      namespace:
        required: true
        type: string
        description: "Kubernetes namespace"

jobs:
  cleanup:
    name: Delete Staging Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS_CFT_AAT }}

      - name: Get AKS Credentials
        uses: azure/aks-set-context@v4
        with:
          resource-group: cft-aat-00-rg
          cluster-name: cft-aat-00-aks
          admin: 'true'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Delete Helm release
        run: |
          echo "Deleting Helm release: ${{ inputs.release-name }} in namespace: ${{ inputs.namespace }}"
          helm uninstall "${{ inputs.release-name }}" \
            --namespace "${{ inputs.namespace }}" \
            --wait \
            --timeout 5m0s || echo "Release may not exist or already deleted"

      - name: Output cleanup summary
        run: |
          echo "### Helm Cleanup Summary :broom:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** \`${{ inputs.release-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** \`${{ inputs.namespace }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deleted" >> $GITHUB_STEP_SUMMARY
