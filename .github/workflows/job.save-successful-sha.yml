# Save Successful SHA Job
#
# Reusable workflow to save the current SHA after a successful stage completion.
# This enables the detect-changes job to compare against the last successful run
# instead of just the previous commit.
#
# Usage:
#   save-code-success:
#     needs: [build-stage]
#     if: always() && needs.build-stage.result == 'success'
#     uses: ./.github/workflows/job.save-successful-sha.yml
#     with:
#       cache-key: code

name: Save Successful SHA

on:
  workflow_call:
    inputs:
      cache-key:
        required: true
        type: string
        description: "Cache key matching the detect-changes cache-key (e.g., 'infra', 'code')"

jobs:
  save-sha:
    name: Save SHA
    runs-on: ubuntu-latest
    steps:
      - name: Save SHA to file
        run: echo "${{ github.sha }}" > .last-successful-sha

      - name: Cache the SHA
        uses: actions/cache/save@v4
        with:
          path: .last-successful-sha
          key: last-successful-${{ inputs.cache-key }}-${{ github.ref_name }}
